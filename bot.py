from telegram import Update
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, filters, ContextTypes
import time
import re

# ------------------- –ù–ê–°–¢–†–û–ô–ö–ò -------------------
TOKEN = "8399873866:AAF-K9_6ytC6Y6l4tbWEuxhY-U3xNToLDEo"


# ------------------- –ü–†–ê–í–ò–õ–ê -------------------
RULES_TEXT = """
üóì –ü—Ä–∞–≤–∏–ª–∞ —á–∞—Ç–∞


–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –≠—Ç–æ –≤–ª–∞–¥–µ–ª–µ—Ü —á–∞—Ç–∞ üíô

1. –ë—É–¥—å—Ç–µ –≤–µ–∂–ª–∏–≤—ã –∏ –Ω–µ –æ—Å–∫–æ—Ä–±–ª—è–π—Ç–µ –¥—Ä—É–≥–∏—Ö —Ç–æ–ª—å–∫–æ –≤ —é–º–æ—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö —Ü–µ–ª—è—Ö –∏ —É–º–µ—Ä–µ–Ω–Ω–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ.üö´

—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —á–∞—Ç–∞.
2. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–µ–Ω–æ—Ä–º–∞—Ç–∏–≤–Ω—É—é –ª–µ–∫—Å–∏–∫—É –≤ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ.üö´

3. –ù–µ –ø–æ–¥–Ω–∏–º–∞–π—Ç–µ –∏ –Ω–µ –æ–±—Å—É–∂–¥–∞–π—Ç–µ –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ, —Ä–µ–ª–∏–≥–∏–æ–∑–Ω—ã–µ –∏ –º–µ–∂–Ω–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–µ–º—ã –∏ –≤–æ–ø—Ä–æ—Å—ã.üö´

4. –ù–µ –æ–±–∏–∂–∞–π—Ç–µ—Å—å –Ω–∞ —à—É—Ç–∫–∏ –∏ –æ—Å–∫–æ—Ä–±–ª–µ–Ω–∏–µ –¥—Ä—É–≥–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –æ–Ω–∏ –º–æ–≥—É—Ç —ç—Ç–æ –¥–µ–ª–∞—Ç—å –≤ —é–º–æ—Ä–∏—Å—Ç–∏—á–µ—Å–∫–æ–º —Å–º—ã—Å–ª–µ ü§ó

5.–ï—Å–ª–∏ –≤–∞—à–∞ —à—É—Ç–∫–∞ –∑–∞–¥–µ–ª–∞ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –±—É–¥—å—Ç–µ –¥–æ–±—Ä—ã –∏–∑–≤–∏–Ω–∏—Ç–µ—Å—å –ø–µ—Ä–µ–¥ —ç—Ç–∏–º —á–µ–ª–æ–≤–µ–∫–æ–º ü§ù

6. –ó–∞–ø—Ä–µ—â–µ–Ω–æ –ø—Ä–∏—Å—ã–ª–∞—Ç—å 18+ –∫–æ–Ω—Ç–µ–Ω—Ç. 

7. –ù–µ –Ω—ã—Ç—å –≤ –≥—Ä—É–ø–ø–µ, —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞—Ç—å –æ —Å–≤–æ–∏—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö —Ä–∞–∑—Ä–µ—à–∞–µ—Ç—Å—è –Ω–æ –Ω–µ –≤ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ, –Ω–µ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –ø—Ä–∏—è—Ç–Ω–æ —á–∏—Ç–∞—Ç—å —ç—Ç–æ üôè

‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
–ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏ 
1.–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–≤–æ–∏ –ø—Ä–∞–≤–∞ –≤  —Å–≤–æ–∏—Ö —Ü–µ–ª—è—Ö.üö´

2. –ë–∞–Ω–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ —Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞.üö´

3.–ë—ã—Ç—å —á–µ—Å—Ç–Ω—ã–º –∫–æ –≤—Å–µ–º.üö´

–ó–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª –≤–æ–∑–º–æ–∂–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —á–∞—Ç–µ.üö´


–ü–æ –≤—Å–µ–º –≤–æ–ø—Ä–æ—Å–∞–º –ø–∏—Å–∞—Ç—å –≤ –ª—Å –≤–ª–∞–¥–µ–ª—å—Ü—É, –≤—ã–¥–∞–Ω–Ω–æ–µ –Ω–∞–∫–∞–∑–∞–Ω–∏–µ –Ω–µ –ø–æ–¥–ª–µ–∂–∏—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏.
–ë—É–¥—å—Ç–µ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã —á—Ç–æ –ø–∏—à–µ—Ç–µ –∏ –∫–æ–º—É –≤—ã —ç—Ç–æ –ø–∏—à–µ—Ç–µ!1
"""

BAD_WORDS = [
    "—Å—É–∫", "–±–ª—è", "–ø–∏–∑–¥", "–ø–∏–¥–æ—Ä", "–µ–±", "—É–µ–±",
    "–¥–æ–ª–±–æ–µ–±", "–º—É–¥–∞–∫", "–≥–æ–Ω–¥–æ–Ω", "—à–ª—é—Ö",
    "—á–º–æ", "—Ç–≤–∞—Ä", "–ª–æ—Ö", "–¥–∞—É–Ω", "—Ö—É–π"
]

REPLACE_MAP = {
    "0": "–æ", "1": "–∏", "3": "–µ", "4": "–∞", "5": "—Å",
    "@": "–∞", "$": "—Å", "!": "–∏",
    "p": "–ø", "x": "—Ö", "y": "—É", "e": "–µ",
    "a": "–∞", "o": "–æ", "c": "—Å", "k": "–∫"
}

last_messages = {}
violations = {}

# ------------------- –§–£–ù–ö–¶–ò–ò -------------------
async def rules(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(RULES_TEXT)

async def welcome(update: Update, context: ContextTypes.DEFAULT_TYPE):
    for user in update.message.new_chat_members:
        await update.message.reply_text(
            f"üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {user.first_name}!\n"
            "‚ùó –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–∑–Ω–∞–∫–æ–º—å—Ç–µ—Å—å —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏ —á–∞—Ç–∞, –æ—Ç–ø—Ä–∞–≤–∏–≤ –∫–æ–º–∞–Ω–¥—É /rules."
        )

def is_flood(user_id):
    now = time.time()
    times = last_messages.get(user_id, [])
    times = [t for t in times if now - t < 5]
    times.append(now)
    last_messages[user_id] = times
    return len(times) > 5

def normalize(text):
    text = text.lower()
    for k, v in REPLACE_MAP.items():
        text = text.replace(k, v)
    return re.sub(r"[^–∞-—è—ë]", "", text)

def check_antimat(user_id, text):
    clean = normalize(text)
    if any(w in clean for w in BAD_WORDS):
        violations[user_id] = violations.get(user_id, 0) + 1
        if violations[user_id] >= 2:
            violations[user_id] = 0
            return True
    return False

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.message.from_user.id
    text = update.message.text

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ñ–ª—É–¥
    if is_flood(user_id):
        await update.message.reply_text("‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ —Ñ–ª—É–¥—å—Ç–µ!")
        return

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –º–∞—Ç
    if check_antimat(user_id, text):
        await update.message.reply_text("üö´ –í—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ —Å–ª–æ–≤–∞ –¥–≤–∞–∂–¥—ã! –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ —Å–±—Ä–æ—à–µ–Ω–æ.")
        return

# ------------------- –û–°–ù–û–í–ù–û–ô –ö–û–î -------------------
app = ApplicationBuilder().token(TOKEN).build()

# –ö–æ–º–∞–Ω–¥—ã
app.add_handler(CommandHandler("rules", rules))

# –ù–æ–≤—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏
app.add_handler(MessageHandler(filters.StatusUpdate.NEW_CHAT_MEMBERS, welcome))

# –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è
app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
app.run_polling()
